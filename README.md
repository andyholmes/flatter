# Flatter

Flatter is a GitHub Action for building and hosting a Flatpak repository in a
static hosting environment, such as GitHub Pages.

## Example

```yml
name: Flatter

on:
  # Rebuild once a day
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  flatter:
    name: Flatter
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/andyholmes/flatter/gnome:43
      options: --privileged

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # See "GPG Signing" below
      - name: Setup GPG
        id: gpg
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Build
        uses: andyholmes/actions/flatter@main
        with:
          files: |
            com.example.App.json
          gpg-sign: ${{ steps.gpg.outputs.fingerprint }}
          upload-pages-artifact: true
          upload-flatpak-bundle: true
```

## Inputs

The only required input is `files`, which should be a list of paths to Flatpak
manifests (JSON or YAML) to build. Typically one or both of
`upload-pages-artifact` and `upload-flatpak-bundle` will be set to `true`,
depending on the deployment style.

| Name                    | Default   | Description                            |
|-------------------------|-----------|----------------------------------------|
| `files` (REQUIRED)      | None      | A list of manifests to build           |
| `upload-flatpak-bundle` | `false`   | Upload each application as a Flatpak   |
| `upload-pages-artifact` | `false`   | Upload the repo for GitHub Pages       |
| `flatpakrepo`           | `true`    | Generate `/index.flatpakrepo` file     |
| `include-files`         | None      | Files to include in the repository     |
| `cache-key`             | `flatter` | A cache key, or `''` to disable        |

There are also inputs that correspond to command-line options for `flatpak` and
`flatpak-builder`, most commonly used:

| Name                    | Default   | Description                            |
|-------------------------|-----------|----------------------------------------|
| `arch`                  | `x86_64`  | The architecture to build for          |
| `gpg-sign`              | None      | A GPG Key fingerprint                  |
| `repo`                  | `repo`    | The repository directory               |

See [`action.yml`](action.yml) for a full list of inputs.


## GPG Signing

Flatter supports signing the repository and bundles with GPG. First generate a
GPG key for your repository:

```sh
mkdir flatter
gpg2 --homedir flatter --quick-gen-key username@github.io
```

Export the private key, then add the key and passphrase as GitHub Action secrets
(e.g. `GPG_PRIVATE_KEY` and `GPG_PASSPHRASE`):

```sh
gpg2 --homedir flatter --armor --export-secret-key username@github.io
```

[`crazy-max/ghaction-import-gpg`][gpg-action] can be used to easily import and
preset the passphrase for signing:

```yml
name: Flatter (Signed)

on:
  # Rebuild once a day
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  flatter:
    name: Flatter
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/andyholmes/flatter/gnome:43
      options: --privileged

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup GPG
        id: gpg
        uses: crazy-max/ghaction-import-gpg@v5
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.GPG_PASSPHRASE }}

      - name: Build
        uses: andyholmes/actions/flatter@main
        with:
          files: |
            build-aux/flatpak/com.example.App.json
          gpg-sign: ${{ steps.gpg.outputs.fingerprint }}
```

[gpg-action]: https://github.com/crazy-max/ghaction-import-gpg

## Deploying Flatter

Flatpak repositories generated by `flatpak-builder` are deployable as static
assets, so deployment is quite flexible.

Flatter will automatically generate a `index.flatpakrepo` file in the repository
directory, unless the `flatpakrepo` input is set to `false`. Other simple files,
like `index.html`, can be added with the `include-files` input.

### GitHub Pages

Flatter can upload the repository as an artifact compatible with GitHub Pages,
allowing the environment of a repository to become a Flatpak repository.

1. Set the `upload-pages-artifact` input to `true`
2. In the **Settings** for the repository, select **Pages** in the sidebar and
   set **Source** to "GitHub Pages"
3. Add a job with [`actions/deploy-pages`][deploy-pages] to the Flatter workflow

```yml
name: Flatter (GitHub Pages)

on:
  # Rebuild once a day
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  flatter:
    name: Flatter
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/andyholmes/flatter/gnome:43
      options: --privileged

    steps:
      - name: Checkout
        uses: actions/checkout@v3
        
      # Generate a CNAME file on-the-fly for a configured host
      - name: Generate CNAME
        run: |
          echo "flutter.andyholmes.ca" > CNAME

      - name: Build
        uses: andyholmes/actions/flatter@main
        with:
          files: |
            build-aux/flatpak/com.example.App.json
          upload-pages-artifact: true
          include-files: |
            CNAME
            index.html
          
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: flatter
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v1
```

[deploy-pages]: https://github.com/actions/deploy-pages

### Custom Deploy

The Flatpak repository directory can also be deployed with another action, such
as [`JamesIves/github-pages-deploy-action`][deploy-custom]. The example below
deploys the Flatpak repository in the subfolder `/repo`, without disturbing
other files in the deployment environment:

```yml
name: Flatter (Deploy)

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  flatter:
    name: Flatter
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/andyholmes/flatter/gnome:43
      options: --privileged
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Build
        uses: andyholmes/actions/flatter@main
        with:
          files: |
            build-aux/flatpak/com.example.App.json
          repo: repo

      - name: Deploy Repository
        uses: JamesIves/github-pages-deploy-action@releases/v4
        with:
          folder: repo
          target-folder: repo
```

[deploy-custom]: https://github.com/JamesIves/github-pages-deploy-action

## Acknowledgements

* [Flatpak](https://flatpak.org)
* [`flatpak/flatpak-github-actions`](https://github.com/flatpak/flatpak-github-actions)
* [`crazy-max/ghaction-import-gpg`](https://github.com/crazy-max/ghaction-import-gpg)
* [`JamesIves/github-pages-deploy-action`](https://github.com/JamesIves/github-pages-deploy-action)
